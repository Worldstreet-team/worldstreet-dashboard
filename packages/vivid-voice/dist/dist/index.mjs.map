{"version":3,"sources":["../src/functions.ts","../src/prompt.ts","../src/realtime-client.ts","../src/persistence.ts","../src/provider.tsx","../src/widget.tsx","../src/audio.ts"],"names":["stream","error","useRef","useEffect","jsx","useState","useCallback"],"mappings":"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","file":"index.mjs","sourcesContent":["/**\r\n * Function Registration System\r\n * \r\n * Utilities for creating and managing voice-callable functions\r\n */\r\n\r\nimport type {\r\n  VoiceFunctionConfig,\r\n  OpenAIFunctionDefinition,\r\n  JSONSchema,\r\n  JSONSchemaProperty,\r\n} from './types'\r\n\r\n/**\r\n * Create a type-safe voice function configuration\r\n * \r\n * @example\r\n * ```ts\r\n * const searchProducts = createVividFunction({\r\n *   name: 'searchProducts',\r\n *   description: 'Search for products in the catalog',\r\n *   parameters: {\r\n *     type: 'object',\r\n *     properties: {\r\n *       query: { type: 'string', description: 'Search query' },\r\n *       limit: { type: 'number', description: 'Max results' },\r\n *     },\r\n *     required: ['query'],\r\n *   },\r\n *   handler: async ({ query, limit }) => {\r\n *     // Your implementation\r\n *     return results\r\n *   },\r\n * })\r\n * ```\r\n */\r\nexport function createVividFunction<\r\n  TParams extends Record<string, unknown> = Record<string, unknown>,\r\n  TResult = unknown,\r\n>(config: VoiceFunctionConfig<TParams, TResult>): VoiceFunctionConfig<TParams, TResult> {\r\n  // Validate function name (OpenAI requirements)\r\n  if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(config.name)) {\r\n    throw new Error(\r\n      `Invalid function name \"${config.name}\". Must start with a letter or underscore and contain only alphanumeric characters and underscores.`\r\n    )\r\n  }\r\n\r\n  // Validate description is present\r\n  if (!config.description || config.description.trim().length === 0) {\r\n    throw new Error(`Function \"${config.name}\" must have a description.`)\r\n  }\r\n\r\n  // Set default execution context\r\n  return {\r\n    ...config,\r\n    executionContext: config.executionContext ?? 'client',\r\n  }\r\n}\r\n\r\n/**\r\n * Function registry for managing registered functions\r\n */\r\nexport class FunctionRegistry {\r\n  private functions: Map<string, VoiceFunctionConfig> = new Map()\r\n\r\n  /**\r\n   * Register a function\r\n   */\r\n  register(config: VoiceFunctionConfig): void {\r\n    if (this.functions.has(config.name)) {\r\n      console.warn(`[Vivid] Function \"${config.name}\" is already registered. Overwriting.`)\r\n    }\r\n    this.functions.set(config.name, config)\r\n  }\r\n\r\n  /**\r\n   * Register multiple functions at once\r\n   */\r\n  registerAll(configs: VoiceFunctionConfig[]): void {\r\n    for (const config of configs) {\r\n      this.register(config)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unregister a function by name\r\n   */\r\n  unregister(name: string): boolean {\r\n    return this.functions.delete(name)\r\n  }\r\n\r\n  /**\r\n   * Get a function by name\r\n   */\r\n  get(name: string): VoiceFunctionConfig | undefined {\r\n    return this.functions.get(name)\r\n  }\r\n\r\n  /**\r\n   * Check if a function is registered\r\n   */\r\n  has(name: string): boolean {\r\n    return this.functions.has(name)\r\n  }\r\n\r\n  /**\r\n   * Get all registered functions\r\n   */\r\n  getAll(): VoiceFunctionConfig[] {\r\n    return Array.from(this.functions.values())\r\n  }\r\n\r\n  /**\r\n   * Get all client-side functions\r\n   */\r\n  getClientFunctions(): VoiceFunctionConfig[] {\r\n    return this.getAll().filter((fn) => fn.executionContext === 'client')\r\n  }\r\n\r\n  /**\r\n   * Get all server-side functions\r\n   */\r\n  getServerFunctions(): VoiceFunctionConfig[] {\r\n    return this.getAll().filter((fn) => fn.executionContext === 'server')\r\n  }\r\n\r\n  /**\r\n   * Convert all registered functions to OpenAI tool definitions\r\n   */\r\n  toOpenAITools(): OpenAIFunctionDefinition[] {\r\n    return this.getAll().map(functionToOpenAITool)\r\n  }\r\n\r\n  /**\r\n   * Clear all registered functions\r\n   */\r\n  clear(): void {\r\n    this.functions.clear()\r\n  }\r\n\r\n  /**\r\n   * Get the count of registered functions\r\n   */\r\n  get size(): number {\r\n    return this.functions.size\r\n  }\r\n}\r\n\r\n/**\r\n * Convert a VoiceFunctionConfig to OpenAI function definition\r\n */\r\nexport function functionToOpenAITool(config: VoiceFunctionConfig): OpenAIFunctionDefinition {\r\n  return {\r\n    name: config.name,\r\n    description: config.description,\r\n    parameters: config.parameters,\r\n  }\r\n}\r\n\r\n/**\r\n * Execute a function from the registry\r\n * Handles both sync and async functions\r\n */\r\nexport async function executeFunction(\r\n  registry: FunctionRegistry,\r\n  name: string,\r\n  args: Record<string, unknown>\r\n): Promise<{\r\n  success: boolean\r\n  result?: unknown\r\n  error?: string\r\n  executionTime: number\r\n}> {\r\n  const startTime = performance.now()\r\n  \r\n  const fn = registry.get(name)\r\n  if (!fn) {\r\n    return {\r\n      success: false,\r\n      error: `Function \"${name}\" not found`,\r\n      executionTime: performance.now() - startTime,\r\n    }\r\n  }\r\n\r\n  try {\r\n    const result = await fn.handler(args)\r\n    return {\r\n      success: true,\r\n      result,\r\n      executionTime: performance.now() - startTime,\r\n    }\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : String(error),\r\n      executionTime: performance.now() - startTime,\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Helper to create a simple string parameter\r\n */\r\nexport function stringParam(description: string, required = true): JSONSchemaProperty & { _required?: boolean } {\r\n  return { type: 'string', description, _required: required } as JSONSchemaProperty & { _required?: boolean }\r\n}\r\n\r\n/**\r\n * Helper to create a number parameter\r\n */\r\nexport function numberParam(description: string, required = false): JSONSchemaProperty & { _required?: boolean } {\r\n  return { type: 'number', description, _required: required } as JSONSchemaProperty & { _required?: boolean }\r\n}\r\n\r\n/**\r\n * Helper to create a boolean parameter\r\n */\r\nexport function booleanParam(description: string, required = false): JSONSchemaProperty & { _required?: boolean } {\r\n  return { type: 'boolean', description, _required: required } as JSONSchemaProperty & { _required?: boolean }\r\n}\r\n\r\n/**\r\n * Helper to create an enum parameter\r\n */\r\nexport function enumParam(description: string, options: string[], required = false): JSONSchemaProperty & { _required?: boolean } {\r\n  return { type: 'string', description, enum: options, _required: required } as JSONSchemaProperty & { _required?: boolean }\r\n}\r\n\r\n/**\r\n * Helper to build parameters schema from param helpers\r\n */\r\nexport function buildParameters(\r\n  params: Record<string, JSONSchemaProperty & { _required?: boolean }>\r\n): JSONSchema {\r\n  const properties: Record<string, JSONSchemaProperty> = {}\r\n  const required: string[] = []\r\n\r\n  for (const [key, param] of Object.entries(params)) {\r\n    const { _required, ...prop } = param as JSONSchemaProperty & { _required?: boolean }\r\n    properties[key] = prop\r\n    if (_required) {\r\n      required.push(key)\r\n    }\r\n  }\r\n\r\n  return {\r\n    type: 'object',\r\n    properties,\r\n    ...(required.length > 0 ? { required } : {}),\r\n  }\r\n}\r\n","/**\r\n * Vivid System Prompt\r\n * \r\n * Base prompt that defines Vivid's core personality and behavior.\r\n * Platform-specific context is appended by the developer.\r\n */\r\n\r\nimport type { VividUser, PlatformContextGenerator } from './types'\r\n\r\n/**\r\n * The base Vivid system prompt - defines core identity and behavior\r\n */\r\nexport const VIVID_BASE_PROMPT = `You are Vivid, a calm and knowledgeable voice AI assistant created by Worldstreet. You're the voice behind Worldstreet's ecosystem of platforms  from the Academy to Xstream, the Store, and the Community.\r\n\r\n## Your Identity\r\n- Name: Vivid\r\n- Creator: Worldstreet\r\n- Purpose: The voice AI powering Worldstreet's ecosystem  Academy, Xstream (livestreaming), Store (e-commerce), and Community (social platform)\r\n- Personality: Warm, composed, and genuinely helpful  like a knowledgeable advisor who takes time to actually listen\r\n\r\n## Worldstreet Ecosystem\r\nYou are aware of and can assist across all Worldstreet platforms:\r\n- **Worldstreet Academy**  Learning and education platform\r\n- **Xstream**  Livestreaming platform\r\n- **Worldstreet Store**  E-commerce marketplace\r\n- **Worldstreet Community**  Social media platform for connecting and collaboration\r\nWhen relevant, you can suggest resources or features from other platforms in the ecosystem.\r\n\r\n## Core Behavior Guidelines\r\n\r\n### Personality & Tone\r\n- Be warm and conversational, but measured  no unnecessary filler, no over-the-top enthusiasm\r\n- Use natural speech: contractions and casual phrasing are fine, but keep a calm, grounded tone\r\n- Avoid hollow hype phrases like \"Great choice!\", \"Amazing!\", \"Absolutely!\"  they undermine trust\r\n- Match the user's energy without amplifying it: if they're direct, be direct; if they're relaxed, stay relaxed\r\n- Show genuine interest in helping  be present and focused, not performatively cheerful\r\n\r\n### Greetings & Personalization\r\n- When you know the user's name, greet them naturally: \"Hi Sarah\", \"Good to hear from you, Marcus\"\r\n- Remember context from the conversation and reference it naturally\r\n- If this is a first interaction, give a calm welcome and briefly say what you can help with\r\n- For returning users, keep it simple: \"Hi, what can I help you with?\"\r\n\r\n### Being Proactive\r\n- Don't just answer questions  notice what the user might need next\r\n- After completing a task, mention a logical next step if there is one: \"You can also check...\" or \"If you need to...\"\r\n- If the user seems unsure, offer options without overwhelming them\r\n- Only suggest things that are genuinely useful  don't pad responses\r\n\r\n### Navigation\r\n- When the user asks to go somewhere, briefly confirm before navigating: \"Taking you to Spot Trading\" or \"Heading to your assets now\"\r\n- Keep the confirmation short  one phrase, then navigate immediately\r\n- Do not ask for permission before navigating unless the destination is ambiguous\r\n\r\n### Action Execution\r\n- When calling functions, acknowledge briefly: \"Let me check that\" or \"One moment\"\r\n- After getting results, summarize conversationally  don't read raw data back\r\n- Confirm before doing anything destructive or irreversible: \"Just to confirm  you want to delete that?\"\r\n- If something fails, stay calm: \"That didn't work. Let me try a different approach\" or suggest a next step\r\n- Never surface raw technical errors  translate them into plain language\r\n\r\n### Knowledge & Honesty\r\n- Be upfront about what you can and can't do\r\n- If you don't know something, say so plainly: \"I'm not sure about that, but here's what I can help with\"\r\n- Guide users toward features they might not know about, without being pushy\r\n- When relevant, point them to the right Worldstreet platform for their need\r\n\r\n### Safety & Privacy\r\n- Never ask for sensitive info like passwords, card numbers, or SSNs through voice\r\n- Protect user privacy in every interaction\r\n- Follow all applicable data protection guidelines\r\n\r\n### Error Handling\r\n- Stay calm when things go wrong  don't catastrophize\r\n- Give clear, practical guidance on next steps\r\n- Don't keep retrying failed actions without checking with the user first\r\n\r\n## Response Format\r\n- Keep responses short: 1-3 sentences for most things\r\n- For complex info, break it into short chunks  don't info-dump\r\n- Ask a clarifying question if you're genuinely unsure what they mean\r\n- Speak at a natural pace  this is a conversation, not a presentation`\r\n\r\n/**\r\n * Build the complete system prompt by combining base + platform context\r\n */\r\nexport async function buildSystemPrompt(\r\n  platformContext: PlatformContextGenerator | undefined,\r\n  user: VividUser | null,\r\n  pathname: string\r\n): Promise<string> {\r\n  let fullPrompt = VIVID_BASE_PROMPT\r\n\r\n  if (platformContext) {\r\n    try {\r\n      const platformPrompt = await platformContext(user, pathname)\r\n      if (platformPrompt && platformPrompt.trim().length > 0) {\r\n        fullPrompt += `\\n\\n## Platform-Specific Context\\n\\n${platformPrompt.trim()}`\r\n      }\r\n    } catch (error) {\r\n      console.error('[Vivid] Error generating platform context:', error)\r\n      // Continue without platform context rather than failing completely\r\n    }\r\n  }\r\n\r\n  // Add user context if available\r\n  if (user) {\r\n    fullPrompt += `\\n\\n## Current User\\n`\r\n    fullPrompt += `- User ID: ${user.id}\\n`\r\n    if (user.firstName) {\r\n      const greeting = user.firstName\r\n      fullPrompt += `- Name: ${greeting}${user.lastName ? ` ${user.lastName}` : ''}\\n`\r\n      fullPrompt += `- IMPORTANT: Address this user by their first name (${greeting}) in a friendly way\\n`\r\n    }\r\n    if (user.email) {\r\n      fullPrompt += `- Email: ${user.email}\\n`\r\n    }\r\n  }\r\n\r\n  return fullPrompt\r\n}\r\n\r\n/**\r\n * Generate function instructions to append to the system prompt\r\n */\r\nexport function generateFunctionInstructions(\r\n  functionNames: string[]\r\n): string {\r\n  if (functionNames.length === 0) {\r\n    return ''\r\n  }\r\n\r\n  return `\r\n## Available Functions\r\nYou have access to the following functions to help the user:\r\n${functionNames.map(name => `- ${name}`).join('\\n')}\r\n\r\nWhen a user asks you to do something that matches one of these functions:\r\n1. Let them know what you're doing in a natural way (\"Let me check that for you\")\r\n2. Call the function with the right parameters\r\n3. Wait for the result\r\n4. Share the outcome conversationally  don't just read back raw data\r\n\r\nIf you're not sure which function to use, ask the user to clarify. If a task is done and there's a logical next step, proactively suggest it.`\r\n}\r\n\r\n/**\r\n * Quick prompt for testing/development\r\n */\r\nexport const VIVID_TEST_PROMPT = `You are Vivid, a test voice assistant by Worldstreet. Keep responses very brief and friendly. Available functions will be provided separately.`\r\n","/**\n * OpenAI Realtime API WebRTC Client\n * \n * Handles WebRTC connection to OpenAI's Realtime API for voice conversations.\n * Based on the proven WebRTC pattern from voice-agent-market.\n */\n\nimport type {\n  OpenAIFunctionDefinition,\n  VividAgentState,\n} from './types'\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface RealtimeClientConfig {\n  /** Ephemeral client_secret from server (from /v1/realtime/sessions) */\n  sessionToken: string\n  /** Full system prompt (sent server-side during session creation) */\n  instructions: string\n  /** Voice to use for responses */\n  voice?: string\n  /** Function definitions */\n  tools?: OpenAIFunctionDefinition[]\n}\n\nexport interface RealtimeClientEvents {\n  onStateChange: (state: VividAgentState) => void\n  onTranscript: (text: string, isFinal: boolean) => void\n  onAudioData: (audio: ArrayBuffer) => void\n  onFunctionCall: (name: string, args: Record<string, unknown>, callId: string) => void\n  onError: (error: Error) => void\n  onResponseDone: () => void\n}\n\ninterface RealtimeEvent {\n  type: string\n  [key: string]: any\n}\n\n// ============================================================================\n// Client Implementation (WebRTC)\n// ============================================================================\n\nexport class RealtimeClient {\n  private pc: RTCPeerConnection | null = null\n  private dc: RTCDataChannel | null = null\n  private audioElement: HTMLAudioElement | null = null\n  private mediaStream: MediaStream | null = null\n  \n  // Audio Analysis\n  private audioContext: AudioContext | null = null\n  private analyser: AnalyserNode | null = null\n  private microphoneNode: MediaStreamAudioSourceNode | null = null\n  private remoteNode: MediaStreamAudioSourceNode | null = null\n\n  private config: RealtimeClientConfig\n  private events: RealtimeClientEvents\n  private state: VividAgentState = 'idle'\n  private isSpeakingRef = false\n\n  private static readonly REALTIME_URL = 'https://api.openai.com/v1/realtime'\n  private static readonly MODEL = 'gpt-4o-realtime-preview-2024-12-17'\n\n  constructor(config: RealtimeClientConfig, events: RealtimeClientEvents) {\n    this.config = config\n    this.events = events\n  }\n\n  /**\n   * Connect to OpenAI Realtime API via WebRTC\n   */\n  async connect(): Promise<void> {\n    if (this.pc) {\n      console.warn('[Vivid] Already connected')\n      return\n    }\n\n    this.setState('connecting')\n\n    try {\n      // 1. Create RTCPeerConnection\n      const pc = new RTCPeerConnection({\n        iceServers: [\n          { urls: 'stun:stun.l.google.com:19302' },\n          { urls: 'stun:stun1.l.google.com:19302' },\n        ],\n      })\n      this.pc = pc\n\n      // 2. Set up audio element for AI voice playback\n      const audioEl = document.createElement('audio')\n      audioEl.autoplay = true\n      audioEl.setAttribute('playsinline', 'true')\n      this.audioElement = audioEl\n      document.body.appendChild(audioEl)\n\n      // Initialize Audio Analysis Context\n      try {\n        this.audioContext = new (window.AudioContext || (window as any).webkitAudioContext)()\n        this.analyser = this.audioContext.createAnalyser()\n        this.analyser.fftSize = 512\n        this.analyser.smoothingTimeConstant = 0.5 // Smooth out the visualization\n      } catch (e) {\n        console.warn('[Vivid] Failed to initialize AudioContext for visualization:', e)\n      }\n\n      pc.ontrack = (event) => {\n        console.log('[Vivid] Received remote audio track:', event.track.kind, event.streams.length, 'streams')\n        const stream = event.streams[0]\n        audioEl.srcObject = stream\n        audioEl.play().catch((e) => {\n          console.warn('[Vivid] Audio autoplay blocked:', e)\n        })\n\n        // Connect remote stream to analyser\n        if (this.audioContext && this.analyser && stream) {\n          try {\n            // Note: Connecting remote stream to WebAudio context might require CORS handling if on different origin\n            this.remoteNode = this.audioContext.createMediaStreamSource(stream)\n            this.remoteNode.connect(this.analyser)\n          } catch (e) {\n            console.warn('[Vivid] Failed to connect remote stream to analyser:', e)\n          }\n        }\n      }\n\n      // Connection state monitoring\n      pc.onconnectionstatechange = () => {\n        console.log('[Vivid] Connection state:', pc.connectionState)\n        if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {\n          this.disconnect()\n        }\n      }\n\n      pc.oniceconnectionstatechange = () => {\n        console.log('[Vivid] ICE connection state:', pc.iceConnectionState)\n      }\n\n      // 3. Get microphone\n      const stream = await navigator.mediaDevices.getUserMedia({\n        audio: {\n          echoCancellation: true,\n          noiseSuppression: true,\n          autoGainControl: true,\n        },\n      })\n      this.mediaStream = stream\n      stream.getTracks().forEach((track) => pc.addTrack(track, stream))\n\n      // Connect microphone stream to analyser\n      if (this.audioContext && this.analyser) {\n        try {\n          this.microphoneNode = this.audioContext.createMediaStreamSource(stream)\n          this.microphoneNode.connect(this.analyser)\n        } catch (e) {\n          console.warn('[Vivid] Failed to connect microphone to analyser:', e)\n        }\n      }\n\n      // 4. Create data channel for events\n      const dc = pc.createDataChannel('oai-events')\n      this.dc = dc\n\n      dc.onopen = () => {\n        console.log('[Vivid] Data channel open')\n        this.setState('ready')\n        // Request an initial greeting after a short delay\n        setTimeout(() => {\n          if (dc.readyState === 'open') {\n            dc.send(JSON.stringify({ type: 'response.create' }))\n          }\n        }, 1000)\n      }\n\n      dc.onmessage = (event) => {\n        try {\n          const data: RealtimeEvent = JSON.parse(event.data)\n          this.handleEvent(data)\n        } catch (err) {\n          console.error('[Vivid] Error parsing event:', err)\n        }\n      }\n\n      dc.onclose = () => {\n        console.log('[Vivid] Data channel closed')\n        this.setState('idle')\n        this.events.onResponseDone()\n      }\n\n      // 5. Create SDP offer and exchange with OpenAI\n      const offer = await pc.createOffer()\n      await pc.setLocalDescription(offer)\n\n      const sdpResponse = await fetch(\n        `${RealtimeClient.REALTIME_URL}?model=${RealtimeClient.MODEL}`,\n        {\n          method: 'POST',\n          headers: {\n            Authorization: `Bearer ${this.config.sessionToken}`,\n            'Content-Type': 'application/sdp',\n          },\n          body: offer.sdp,\n        }\n      )\n\n      if (!sdpResponse.ok) {\n        const errorText = await sdpResponse.text()\n        throw new Error(`SDP exchange failed (${sdpResponse.status}): ${errorText}`)\n      }\n\n      const answerSdp = await sdpResponse.text()\n      await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp })\n\n      console.log('[Vivid] WebRTC connection established')\n    } catch (error) {\n      console.error('[Vivid] Connection failed:', error)\n      this.setState('error')\n      this.events.onError(error instanceof Error ? error : new Error(String(error)))\n      this.disconnect()\n    }\n  }\n\n  /**\n   * Get current audio frequency data for visualization\n   */\n  getAudioLevels(): Uint8Array {\n    if (!this.analyser) {\n      return new Uint8Array(0)\n    }\n    const dataArray = new Uint8Array(this.analyser.frequencyBinCount)\n    this.analyser.getByteFrequencyData(dataArray)\n    return dataArray\n  }\n\n  /**\n   * Disconnect from the API\n   */\n  disconnect(): void {\n    if (this.audioContext) {\n      this.audioContext.close().catch(() => {})\n      this.audioContext = null\n      this.analyser = null\n      this.microphoneNode = null\n      this.remoteNode = null\n    }\n    if (this.dc) {\n      this.dc.close()\n      this.dc = null\n    }\n\n    if (this.pc) {\n      this.pc.close()\n      this.pc = null\n    }\n\n    if (this.mediaStream) {\n      this.mediaStream.getTracks().forEach((track) => track.stop())\n      this.mediaStream = null\n    }\n\n    if (this.audioElement) {\n      this.audioElement.srcObject = null\n      this.audioElement.parentNode?.removeChild(this.audioElement)\n      this.audioElement = null\n    }\n\n    this.isSpeakingRef = false\n    this.setState('idle')\n  }\n\n  /**\n   * Send audio data - not used with WebRTC (audio flows via media tracks)\n   * Kept for API compatibility\n   */\n  sendAudio(_base64Audio: string): void {\n    // WebRTC handles audio via media tracks, no manual sending needed\n  }\n\n  /**\n   * Commit the audio buffer (for manual turn detection)\n   */\n  commitAudioBuffer(): void {\n    this.sendEvent({ type: 'input_audio_buffer.commit' })\n  }\n\n  /**\n   * Clear the audio buffer\n   */\n  clearAudioBuffer(): void {\n    this.sendEvent({ type: 'input_audio_buffer.clear' })\n  }\n\n  /**\n   * Send a function call result back to the API\n   */\n  sendFunctionResult(callId: string, result: unknown): void {\n    this.sendEvent({\n      type: 'conversation.item.create',\n      item: {\n        type: 'function_call_output',\n        call_id: callId,\n        output: JSON.stringify(result),\n      },\n    })\n\n    // Trigger response generation after function result\n    this.sendEvent({ type: 'response.create' })\n  }\n\n  /**\n   * Cancel the current response\n   */\n  cancelResponse(): void {\n    this.sendEvent({ type: 'response.cancel' })\n  }\n\n  /**\n   * Send a text message\n   */\n  sendMessage(text: string): void {\n    this.sendEvent({\n      type: 'conversation.item.create',\n      item: {\n        type: 'message',\n        role: 'user',\n        content: [{ type: 'input_text', text }],\n      },\n    })\n    this.sendEvent({ type: 'response.create' })\n  }\n\n  /**\n   * Check if connected\n   */\n  isConnected(): boolean {\n    return this.dc?.readyState === 'open'\n  }\n\n  /**\n   * Get current state\n   */\n  getState(): VividAgentState {\n    return this.state\n  }\n\n  /**\n   * Get the media stream (for audio visualizers)\n   */\n  getMediaStream(): MediaStream | null {\n    return this.mediaStream\n  }\n\n  // ============================================================================\n  // Private Methods\n  // ============================================================================\n\n  private setState(state: VividAgentState): void {\n    if (this.state !== state) {\n      this.state = state\n      this.events.onStateChange(state)\n    }\n  }\n\n  private sendEvent(event: Record<string, unknown>): void {\n    if (this.dc?.readyState === 'open') {\n      this.dc.send(JSON.stringify(event))\n    }\n  }\n\n  private handleEvent(event: RealtimeEvent): void {\n    switch (event.type) {\n      case 'session.created':\n        console.log('[Vivid] Session created:', JSON.stringify(event.session || {}, null, 2))\n        break\n\n      case 'session.updated':\n        console.log('[Vivid] Session updated')\n        break\n\n      case 'conversation.item.input_audio_transcription.completed':\n        // User speech was transcribed\n        console.log('[Vivid] User said:', event.transcript)\n        this.events.onTranscript(event.transcript, true)\n        break\n\n      case 'conversation.item.input_audio_transcription.failed':\n        // Transcription failed - log the reason but don't block\n        console.warn('[Vivid] Transcription failed:', JSON.stringify(event.error || event))\n        break\n\n      case 'response.audio_transcript.done':\n        // AI finished speaking - final transcript\n        console.log('[Vivid] AI said:', event.transcript)\n        this.events.onTranscript(event.transcript, true)\n        break\n\n      case 'response.audio.delta':\n        // AI is producing audio (WebRTC delivers actual audio via tracks)\n        if (!this.isSpeakingRef) {\n          this.isSpeakingRef = true\n          this.setState('speaking')\n          console.log('[Vivid] AI started speaking (audio.delta received)')\n        }\n        break\n\n      case 'response.function_call_arguments.done':\n        // Function call is complete\n        this.handleFunctionCall(event)\n        break\n\n      case 'response.created':\n        console.log('[Vivid] Response created:', event.response?.id)\n        break\n\n      case 'response.done':\n        console.log('[Vivid] Response done:', event.response?.status, event.response?.status_details || '')\n        this.isSpeakingRef = false\n        this.setState('ready')\n        this.events.onResponseDone()\n        break\n\n      case 'input_audio_buffer.speech_started':\n        console.log('[Vivid] User started speaking')\n        this.setState('listening')\n        break\n\n      case 'input_audio_buffer.speech_stopped':\n        console.log('[Vivid] User stopped speaking')\n        this.setState('processing')\n        break\n\n      case 'input_audio_buffer.committed':\n        console.log('[Vivid] Audio buffer committed')\n        break\n\n      case 'error':\n        console.error('[Vivid] API Error:', JSON.stringify(event.error))\n        this.events.onError(\n          new Error(event.error?.message || 'Realtime API error')\n        )\n        break\n\n      default:\n        console.log('[Vivid] Unhandled event:', event.type, event)\n        break\n    }\n  }\n\n  private handleFunctionCall(event: RealtimeEvent): void {\n    try {\n      const args = JSON.parse(event.arguments || '{}')\n      this.events.onFunctionCall(event.name, args, event.call_id)\n    } catch (error) {\n      console.error('[Vivid] Error parsing function arguments:', error)\n      this.sendFunctionResult(event.call_id, {\n        error: 'Failed to parse function arguments',\n      })\n    }\n  }\n}\n\n/**\n * Create a new RealtimeClient instance\n */\nexport function createRealtimeClient(\n  config: RealtimeClientConfig,\n  events: RealtimeClientEvents\n): RealtimeClient {\n  return new RealtimeClient(config, events)\n}\n","/**\r\n * Conversation Persistence\r\n * \r\n * Handles storing and retrieving conversation history from localStorage\r\n */\r\n\r\nimport type { ConversationTurn, PersistedConversation } from './types'\r\n\r\nconst STORAGE_KEY = 'vivid_conversation'\r\nconst STORAGE_VERSION = 1\r\n\r\ninterface StorageData {\r\n  version: number\r\n  conversation: PersistedConversation\r\n}\r\n\r\n/**\r\n * Conversation persistence manager\r\n */\r\nexport class ConversationStore {\r\n  private maxHistory: number\r\n  private storageKey: string\r\n\r\n  constructor(options: { maxHistory?: number; namespace?: string } = {}) {\r\n    this.maxHistory = options.maxHistory ?? 50\r\n    this.storageKey = options.namespace \r\n      ? `${STORAGE_KEY}_${options.namespace}`\r\n      : STORAGE_KEY\r\n  }\r\n\r\n  /**\r\n   * Save conversation to localStorage\r\n   */\r\n  save(turns: ConversationTurn[]): void {\r\n    if (typeof window === 'undefined') return\r\n\r\n    try {\r\n      // Trim to max history\r\n      const trimmedTurns = turns.slice(-this.maxHistory)\r\n\r\n      const data: StorageData = {\r\n        version: STORAGE_VERSION,\r\n        conversation: {\r\n          sessionId: this.getOrCreateSessionId(),\r\n          turns: trimmedTurns,\r\n          lastUpdated: Date.now(),\r\n        },\r\n      }\r\n\r\n      localStorage.setItem(this.storageKey, JSON.stringify(data))\r\n    } catch (error) {\r\n      console.warn('[Vivid] Failed to save conversation:', error)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Load conversation from localStorage\r\n   */\r\n  load(): ConversationTurn[] {\r\n    if (typeof window === 'undefined') return []\r\n\r\n    try {\r\n      const raw = localStorage.getItem(this.storageKey)\r\n      if (!raw) return []\r\n\r\n      const data: StorageData = JSON.parse(raw)\r\n\r\n      // Version check for future migrations\r\n      if (data.version !== STORAGE_VERSION) {\r\n        console.log('[Vivid] Clearing outdated conversation storage')\r\n        this.clear()\r\n        return []\r\n      }\r\n\r\n      return data.conversation.turns\r\n    } catch (error) {\r\n      console.warn('[Vivid] Failed to load conversation:', error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a single turn to the conversation\r\n   */\r\n  addTurn(turn: ConversationTurn): void {\r\n    const turns = this.load()\r\n    turns.push(turn)\r\n    this.save(turns)\r\n  }\r\n\r\n  /**\r\n   * Clear all stored conversation data\r\n   */\r\n  clear(): void {\r\n    if (typeof window === 'undefined') return\r\n\r\n    try {\r\n      localStorage.removeItem(this.storageKey)\r\n      localStorage.removeItem(`${this.storageKey}_session`)\r\n    } catch (error) {\r\n      console.warn('[Vivid] Failed to clear conversation:', error)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the current session ID or create a new one\r\n   */\r\n  private getOrCreateSessionId(): string {\r\n    const sessionKey = `${this.storageKey}_session`\r\n    let sessionId = localStorage.getItem(sessionKey)\r\n\r\n    if (!sessionId) {\r\n      sessionId = `vivid_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`\r\n      localStorage.setItem(sessionKey, sessionId)\r\n    }\r\n\r\n    return sessionId\r\n  }\r\n\r\n  /**\r\n   * Get time since last conversation update\r\n   */\r\n  getTimeSinceLastUpdate(): number | null {\r\n    if (typeof window === 'undefined') return null\r\n\r\n    try {\r\n      const raw = localStorage.getItem(this.storageKey)\r\n      if (!raw) return null\r\n\r\n      const data: StorageData = JSON.parse(raw)\r\n      return Date.now() - data.conversation.lastUpdated\r\n    } catch {\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if there's an existing conversation\r\n   */\r\n  hasConversation(): boolean {\r\n    return this.load().length > 0\r\n  }\r\n}\r\n\r\n/**\r\n * Generate a unique ID for conversation turns\r\n */\r\nexport function generateTurnId(): string {\r\n  return `turn_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`\r\n}\r\n\r\n/**\r\n * Create a user turn\r\n */\r\nexport function createUserTurn(content: string): ConversationTurn {\r\n  return {\r\n    id: generateTurnId(),\r\n    role: 'user',\r\n    content,\r\n    timestamp: Date.now(),\r\n  }\r\n}\r\n\r\n/**\r\n * Create an assistant turn\r\n */\r\nexport function createAssistantTurn(\r\n  content: string,\r\n  functionCalls?: ConversationTurn['functionCalls']\r\n): ConversationTurn {\r\n  return {\r\n    id: generateTurnId(),\r\n    role: 'assistant',\r\n    content,\r\n    timestamp: Date.now(),\r\n    functionCalls,\r\n  }\r\n}\r\n\r\n/**\r\n * Format conversation history for context window\r\n * Converts turns to a format suitable for the system prompt\r\n */\r\nexport function formatConversationForContext(\r\n  turns: ConversationTurn[],\r\n  maxTurns = 10\r\n): string {\r\n  const recentTurns = turns.slice(-maxTurns)\r\n  \r\n  if (recentTurns.length === 0) return ''\r\n\r\n  const formatted = recentTurns\r\n    .map((turn) => {\r\n      const role = turn.role === 'user' ? 'User' : 'Vivid'\r\n      let text = `${role}: ${turn.content}`\r\n      \r\n      if (turn.functionCalls && turn.functionCalls.length > 0) {\r\n        const fnSummary = turn.functionCalls\r\n          .map((fc) => `[Called ${fc.name}]`)\r\n          .join(' ')\r\n        text += ` ${fnSummary}`\r\n      }\r\n      \r\n      return text\r\n    })\r\n    .join('\\n')\r\n\r\n  return `\\n\\n## Recent Conversation History\\n${formatted}`\r\n}\r\n","'use client'\r\n\r\n/**\r\n * Vivid Voice Agent Provider\r\n * \r\n * React context provider for the Vivid voice agent\r\n */\r\n\r\nimport {\r\n  createContext,\r\n  useContext,\r\n  useCallback,\r\n  useEffect,\r\n  useRef,\r\n  useState,\r\n  useMemo,\r\n  type ReactNode,\r\n} from 'react'\r\n\r\nimport type {\r\n  VividConfig,\r\n  VividContextValue,\r\n  VividAgentState,\r\n  VoiceFunctionConfig,\r\n  ConversationTurn,\r\n  VividUser,\r\n  FunctionCallRecord,\r\n} from './types'\r\nimport { FunctionRegistry, executeFunction } from './functions'\r\nimport { buildSystemPrompt, generateFunctionInstructions } from './prompt'\r\nimport { RealtimeClient, type RealtimeClientConfig } from './realtime-client'\r\nimport {\r\n  ConversationStore,\r\n  createUserTurn,\r\n  createAssistantTurn,\r\n  formatConversationForContext,\r\n} from './persistence'\r\n\r\n// ============================================================================\r\n// Context\r\n// ============================================================================\r\n\r\nconst VividContext = createContext<VividContextValue | null>(null)\r\n\r\n// ============================================================================\r\n// Provider Props\r\n// ============================================================================\r\n\r\nexport interface VividProviderProps extends VividConfig {\r\n  children: ReactNode\r\n  /**\r\n   * Token endpoint URL - defaults to /api/vivid/token\r\n   * The endpoint should return { token: string } or { sessionToken: string }\r\n   */\r\n  tokenEndpoint?: string\r\n  /**\r\n   * Voice to use for Vivid's responses\r\n   * @default 'alloy'\r\n   */\r\n  voice?: 'alloy' | 'ash' | 'ballad' | 'coral' | 'echo' | 'sage' | 'shimmer' | 'verse' | 'marin' | 'cedar'\r\n  /**\r\n   * Clerk user object (if using Clerk)\r\n   * Pass from useUser() hook in your app\r\n   */\r\n  user?: VividUser | null\r\n  /**\r\n   * Whether user is signed in (if using Clerk)\r\n   * Pass from useAuth() hook in your app\r\n   */\r\n  isSignedIn?: boolean\r\n  /**\r\n   * Current pathname for context\r\n   * Pass from usePathname() hook in your app\r\n   */\r\n  pathname?: string\r\n}\r\n\r\n// ============================================================================\r\n// Provider Component\r\n// ============================================================================\r\n\r\nexport function VividProvider({\r\n  children,\r\n  tokenEndpoint = '/api/vivid/token',\r\n  voice = 'alloy',\r\n  user = null,\r\n  isSignedIn = true,\r\n  pathname = '/',\r\n  requireAuth = false,\r\n  platformContext,\r\n  functions = [],\r\n  onAuthRequired,\r\n  persistConversation = true,\r\n  maxHistoryLength = 50,\r\n  classNames,\r\n}: VividProviderProps) {\r\n  // ============================================================================\r\n  // State\r\n  // ============================================================================\r\n  \r\n  const [state, setState] = useState<VividAgentState>('idle')\r\n  const [conversation, setConversation] = useState<ConversationTurn[]>([])\r\n  const [lastTranscript, setLastTranscript] = useState<string | null>(null)\r\n  const [error, setError] = useState<Error | null>(null)\r\n\r\n  // ============================================================================\r\n  // Refs\r\n  // ============================================================================\r\n  \r\n  const clientRef = useRef<RealtimeClient | null>(null)\r\n  const functionRegistry = useRef(new FunctionRegistry())\r\n  const conversationStore = useRef<ConversationStore | null>(null)\r\n  const currentTranscript = useRef<string>('')\r\n  const pendingFunctionCalls = useRef<FunctionCallRecord[]>([])\r\n\r\n  // ============================================================================\r\n  // Initialization\r\n  // ============================================================================\r\n\r\n  // Initialize conversation store\r\n  useEffect(() => {\r\n    if (persistConversation) {\r\n      conversationStore.current = new ConversationStore({ maxHistory: maxHistoryLength })\r\n      const savedConversation = conversationStore.current.load()\r\n      if (savedConversation.length > 0) {\r\n        setConversation(savedConversation)\r\n      }\r\n    }\r\n  }, [persistConversation, maxHistoryLength])\r\n\r\n  // Register provided functions\r\n  useEffect(() => {\r\n    functionRegistry.current.clear()\r\n    functionRegistry.current.registerAll(functions)\r\n  }, [functions])\r\n\r\n  // ============================================================================\r\n  // Session Management\r\n  // ============================================================================\r\n\r\n  const startSession = useCallback(async () => {\r\n    // Prevent multiple concurrent session attempts\r\n    if (state === 'connecting' || state === 'listening' || state === 'ready' || state === 'speaking' || state === 'processing') {\r\n      console.warn('[Vivid] Session already active or connecting, ignoring duplicate startSession call')\r\n      return\r\n    }\r\n\r\n    // Auth check\r\n    if (requireAuth && !isSignedIn) {\r\n      onAuthRequired?.()\r\n      setError(new Error('Authentication required'))\r\n      return\r\n    }\r\n\r\n    try {\r\n      setState('connecting')\r\n      setError(null)\r\n\r\n      // Evaluate platform context before token fetch so server can build full prompt\r\n      let platformPrompt = ''\r\n      if (platformContext) {\r\n        try {\r\n          const result = await platformContext(user, pathname)\r\n          if (result && result.trim().length > 0) {\r\n            platformPrompt = result.trim()\r\n          }\r\n        } catch (e) {\r\n          console.error('[Vivid] Error evaluating platform context:', e)\r\n        }\r\n      }\r\n\r\n      // Fetch session token from backend\r\n      const tokenResponse = await fetch(tokenEndpoint, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          userId: user?.id,\r\n          pathname,\r\n          platformPrompt,\r\n          userName: user?.firstName || undefined,\r\n          userLastName: user?.lastName || undefined,\r\n          userEmail: user?.email || undefined,\r\n        }),\r\n      })\r\n\r\n      if (!tokenResponse.ok) {\r\n        throw new Error(`Failed to get session token: ${tokenResponse.statusText}`)\r\n      }\r\n\r\n      const { token, sessionToken, client_secret } = await tokenResponse.json()\r\n      const apiToken = client_secret || token || sessionToken\r\n\r\n      if (!apiToken) {\r\n        throw new Error('No session token received')\r\n      }\r\n\r\n      // Build system prompt\r\n      const basePrompt = await buildSystemPrompt(platformContext, user, pathname)\r\n      const functionInstructions = generateFunctionInstructions(\r\n        functionRegistry.current.getAll().map((f) => f.name)\r\n      )\r\n      const conversationContext = formatConversationForContext(conversation)\r\n      const fullInstructions = basePrompt + functionInstructions + conversationContext\r\n\r\n      // Create realtime client (WebRTC - handles audio natively)\r\n      const clientConfig: RealtimeClientConfig = {\r\n        sessionToken: apiToken,\r\n        instructions: fullInstructions,\r\n        voice,\r\n        tools: functionRegistry.current.toOpenAITools(),\r\n      }\r\n\r\n      clientRef.current = new RealtimeClient(clientConfig, {\r\n        onStateChange: (newState) => setState(newState),\r\n        onTranscript: (text, isFinal) => {\r\n          if (isFinal) {\r\n            setLastTranscript(text)\r\n          }\r\n          currentTranscript.current += text\r\n        },\r\n        onAudioData: () => {\r\n          // WebRTC handles audio playback natively via <audio> element\r\n        },\r\n        onFunctionCall: handleFunctionCall,\r\n        onError: (err) => setError(err),\r\n        onResponseDone: handleResponseDone,\r\n      })\r\n\r\n      await clientRef.current.connect()\r\n\r\n    } catch (err) {\r\n      setState('error')\r\n      setError(err instanceof Error ? err : new Error(String(err)))\r\n      console.error('[Vivid] Failed to start session:', err)\r\n    }\r\n  }, [\r\n    state,\r\n    requireAuth,\r\n    isSignedIn,\r\n    onAuthRequired,\r\n    tokenEndpoint,\r\n    user,\r\n    platformContext,\r\n    pathname,\r\n    voice,\r\n    conversation,\r\n  ])\r\n\r\n  const endSession = useCallback(() => {\r\n    // Disconnect WebRTC client (handles audio cleanup internally)\r\n    clientRef.current?.disconnect()\r\n    clientRef.current = null\r\n\r\n    // Reset state\r\n    setState('idle')\r\n    currentTranscript.current = ''\r\n    pendingFunctionCalls.current = []\r\n  }, [])\r\n\r\n  // ============================================================================\r\n  // Function Call Handling\r\n  // ============================================================================\r\n\r\n  const handleFunctionCall = useCallback(\r\n    async (name: string, args: Record<string, unknown>, callId: string) => {\r\n      console.log(`[Vivid] Function call: ${name}`, args)\r\n\r\n      const startTime = performance.now()\r\n      const fnConfig = functionRegistry.current.get(name)\r\n\r\n      if (!fnConfig) {\r\n        console.error(`[Vivid] Function not found: ${name}`)\r\n        clientRef.current?.sendFunctionResult(callId, {\r\n          error: `Function \"${name}\" not found`,\r\n        })\r\n        return\r\n      }\r\n\r\n      try {\r\n        let result: unknown\r\n\r\n        if (fnConfig.executionContext === 'server') {\r\n          // Execute via Server Action bridge\r\n          const response = await fetch('/api/vivid/function', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({ name, args }),\r\n          })\r\n\r\n          if (!response.ok) {\r\n            throw new Error(`Server function failed: ${response.statusText}`)\r\n          }\r\n\r\n          const data = await response.json()\r\n          result = data.result\r\n        } else {\r\n          // Execute client-side\r\n          const execResult = await executeFunction(functionRegistry.current, name, args)\r\n          if (!execResult.success) {\r\n            throw new Error(execResult.error)\r\n          }\r\n          result = execResult.result\r\n        }\r\n\r\n        // Track function call\r\n        pendingFunctionCalls.current.push({\r\n          name,\r\n          arguments: args,\r\n          result,\r\n          executionTime: performance.now() - startTime,\r\n        })\r\n\r\n        // Send result back to API\r\n        clientRef.current?.sendFunctionResult(callId, result)\r\n\r\n      } catch (err) {\r\n        const error = err instanceof Error ? err.message : String(err)\r\n        \r\n        pendingFunctionCalls.current.push({\r\n          name,\r\n          arguments: args,\r\n          error,\r\n          executionTime: performance.now() - startTime,\r\n        })\r\n\r\n        clientRef.current?.sendFunctionResult(callId, { error })\r\n      }\r\n    },\r\n    []\r\n  )\r\n\r\n  const handleResponseDone = useCallback(() => {\r\n    // Save conversation turn\r\n    if (currentTranscript.current) {\r\n      const turn = createAssistantTurn(\r\n        currentTranscript.current,\r\n        pendingFunctionCalls.current.length > 0\r\n          ? [...pendingFunctionCalls.current]\r\n          : undefined\r\n      )\r\n\r\n      setConversation((prev) => {\r\n        const updated = [...prev, turn]\r\n        conversationStore.current?.save(updated)\r\n        return updated\r\n      })\r\n    }\r\n\r\n    // Reset for next response\r\n    currentTranscript.current = ''\r\n    pendingFunctionCalls.current = []\r\n  }, [])\r\n\r\n  // ============================================================================\r\n  // Conversation Management\r\n  // ============================================================================\r\n\r\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n  const _addUserTurn = useCallback((content: string) => {\r\n    const turn = createUserTurn(content)\r\n    setConversation((prev) => {\r\n      const updated = [...prev, turn]\r\n      conversationStore.current?.save(updated)\r\n      return updated\r\n    })\r\n  }, [])\r\n\r\n  const clearHistory = useCallback(() => {\r\n    setConversation([])\r\n    conversationStore.current?.clear()\r\n  }, [])\r\n\r\n  // ============================================================================\r\n  // Manual Controls\r\n  // ============================================================================\r\n\r\n  const startListening = useCallback(() => {\r\n    // WebRTC handles audio capture natively via getUserMedia\r\n    // This is a no-op since audio streams when connected\r\n    console.log('[Vivid] startListening - audio captured via WebRTC')\r\n  }, [])\r\n\r\n  const stopListening = useCallback(() => {\r\n    // With server_vad, turn detection is automatic\r\n    // Manual commit can still be triggered if needed\r\n    clientRef.current?.commitAudioBuffer()\r\n  }, [])\r\n\r\n  const getAudioLevels = useCallback(() => {\r\n    if (clientRef.current) {\r\n      return clientRef.current.getAudioLevels()\r\n    }\r\n    return new Uint8Array(0)\r\n  }, [])\r\n\r\n  // ============================================================================\r\n  // Function Registration (dynamic)\r\n  // ============================================================================\r\n\r\n  const registerFunction = useCallback((fn: VoiceFunctionConfig) => {\r\n    functionRegistry.current.register(fn)\r\n  }, [])\r\n\r\n  const unregisterFunction = useCallback((name: string) => {\r\n    functionRegistry.current.unregister(name)\r\n  }, [])\r\n\r\n  // ============================================================================\r\n  // Cleanup\r\n  // ============================================================================\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      endSession()\r\n    }\r\n  }, [endSession])\r\n\r\n  // ============================================================================\r\n  // Context Value\r\n  // ============================================================================\r\n\r\n  const contextValue = useMemo<VividContextValue>(\r\n    () => ({\r\n      state,\r\n      isConnected: state !== 'idle' && state !== 'error' && state !== 'connecting',\r\n      isListening: state === 'listening',\r\n      isSpeaking: state === 'speaking',\r\n      conversation,\r\n      lastTranscript,\r\n      error,\r\n      startSession,\r\n      endSession,\r\n      clearHistory,\r\n      startListening,\r\n      stopListening,\r\n      getAudioLevels,\r\n      config: {\r\n        requireAuth,\r\n        platformContext,\r\n        functions,\r\n        onAuthRequired,\r\n        classNames,\r\n        persistConversation,\r\n        maxHistoryLength,\r\n      },\r\n      registerFunction,\r\n      unregisterFunction,\r\n    }),\r\n    [\r\n      state,\r\n      conversation,\r\n      lastTranscript,\r\n      error,\r\n      startSession,\r\n      endSession,\r\n      clearHistory,\r\n      startListening,\r\n      stopListening,\r\n      getAudioLevels,\r\n      requireAuth,\r\n      platformContext,\r\n      functions,\r\n      onAuthRequired,\r\n      classNames,\r\n      persistConversation,\r\n      maxHistoryLength,\r\n      registerFunction,\r\n      unregisterFunction,\r\n    ]\r\n  )\r\n\r\n  return (\r\n    <VividContext.Provider value={contextValue}>\r\n      {children}\r\n    </VividContext.Provider>\r\n  )\r\n}\r\n\r\n// ============================================================================\r\n// Hook\r\n// ============================================================================\r\n\r\n/**\r\n * Access the Vivid voice agent context\r\n */\r\nexport function useVivid(): VividContextValue {\r\n  const context = useContext(VividContext)\r\n  \r\n  if (!context) {\r\n    throw new Error('useVivid must be used within a VividProvider')\r\n  }\r\n  \r\n  return context\r\n}\r\n\r\n/**\r\n * Check if Vivid provider is available\r\n */\r\nexport function useVividOptional(): VividContextValue | null {\r\n  return useContext(VividContext)\r\n}\r\n","'use client'\r\n\r\n/**\r\n * Vivid Voice Widget\r\n * \r\n * Floating button component for voice interaction\r\n */\r\n\r\nimport React, { useCallback, useEffect, useRef, useState } from 'react'\r\nimport { useVivid } from './provider'\r\nimport type { VividWidgetProps, VividAgentState } from './types'\r\n\r\n// ============================================================================\r\n// Default Styles (Tailwind classes)\r\n// ============================================================================\r\n\r\nconst defaultClassNames = {\r\n  container: 'fixed bottom-6 right-6 z-50 flex flex-col items-end gap-3',\r\n  button: 'rounded-full bg-gradient-to-br from-violet-500 to-purple-600 text-white shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center',\r\n  buttonActive: 'from-red-500 to-rose-600 animate-pulse',\r\n  transcript: 'bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm rounded-2xl shadow-xl p-4 max-w-sm text-sm border border-gray-200 dark:border-gray-700',\r\n  status: 'text-xs text-gray-500 dark:text-gray-400 mt-1',\r\n  visualizer: 'flex items-center gap-0.5',\r\n}\r\n\r\nconst sizeClasses = {\r\n  sm: 'w-12 h-12',\r\n  md: 'w-14 h-14',\r\n  lg: 'w-16 h-16',\r\n}\r\n\r\n// ============================================================================\r\n// Icons\r\n// ============================================================================\r\n\r\nfunction MicrophoneIcon({ className }: { className?: string }) {\r\n  return (\r\n    <svg className={className} viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n      <path d=\"M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z\" />\r\n      <path d=\"M19 10v2a7 7 0 0 1-14 0v-2\" />\r\n      <line x1=\"12\" y1=\"19\" x2=\"12\" y2=\"23\" />\r\n      <line x1=\"8\" y1=\"23\" x2=\"16\" y2=\"23\" />\r\n    </svg>\r\n  )\r\n}\r\n\r\nfunction StopIcon({ className }: { className?: string }) {\r\n  return (\r\n    <svg className={className} viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n      <rect x=\"6\" y=\"6\" width=\"12\" height=\"12\" rx=\"2\" />\r\n    </svg>\r\n  )\r\n}\r\n\r\nfunction SpinnerIcon({ className }: { className?: string }) {\r\n  return (\r\n    <svg className={className} viewBox=\"0 0 24 24\" fill=\"none\">\r\n      <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\r\n      <path\r\n        className=\"opacity-75\"\r\n        fill=\"currentColor\"\r\n        d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\r\n      />\r\n    </svg>\r\n  )\r\n}\r\n\r\nfunction WaveformIcon({ className, animate }: { className?: string; animate?: boolean }) {\r\n  return (\r\n    <svg className={className} viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n      <rect x=\"4\" y=\"10\" width=\"2\" height=\"4\" rx=\"1\" className={animate ? 'animate-pulse' : ''} />\r\n      <rect x=\"8\" y=\"7\" width=\"2\" height=\"10\" rx=\"1\" className={animate ? 'animate-pulse delay-75' : ''} />\r\n      <rect x=\"12\" y=\"4\" width=\"2\" height=\"16\" rx=\"1\" className={animate ? 'animate-pulse delay-100' : ''} />\r\n      <rect x=\"16\" y=\"7\" width=\"2\" height=\"10\" rx=\"1\" className={animate ? 'animate-pulse delay-150' : ''} />\r\n      <rect x=\"20\" y=\"10\" width=\"2\" height=\"4\" rx=\"1\" className={animate ? 'animate-pulse delay-200' : ''} />\r\n    </svg>\r\n  )\r\n}\r\n\r\n// ============================================================================\r\n// Orb Visualizer\r\n// ============================================================================\r\n\r\ninterface OrbVisualizerProps {\r\n  state: VividAgentState\r\n  onClick: () => void\r\n  size?: 'sm' | 'md' | 'lg'\r\n}\r\n\r\nfunction OrbVisualizer({ state, onClick, size = 'md' }: OrbVisualizerProps) {\r\n  const canvasRef = useRef<HTMLCanvasElement>(null)\r\n  const containerRef = useRef<HTMLDivElement>(null)\r\n  const { getAudioLevels } = useVivid()\r\n  const requestRef = useRef<number>()\r\n  \r\n  // Configuration\r\n  const segmentCount = 60\r\n  const baseRadius = size === 'sm' ? 24 : size === 'lg' ? 40 : 32\r\n  \r\n  // Color palette (Blue -> Pink gradient)\r\n  const colors = {\r\n    ring: { r: 60, g: 100, b: 255 },    // Blue\r\n    active: { r: 255, g: 50, b: 150 },  // Pink/Purple\r\n    glow: { r: 100, g: 150, b: 255 }    // Light Blue Glow\r\n  }\r\n\r\n  useEffect(() => {\r\n    const canvas = canvasRef.current\r\n    if (!canvas) return\r\n    \r\n    // Handle High DPI displays\r\n    const dpr = window.devicePixelRatio || 1\r\n    const rect = canvas.getBoundingClientRect()\r\n    canvas.width = rect.width * dpr\r\n    canvas.height = rect.height * dpr\r\n    const ctx = canvas.getContext('2d')\r\n    if (!ctx) return\r\n    ctx.scale(dpr, dpr)\r\n\r\n    let time = 0\r\n\r\n    const animate = () => {\r\n      // Get Audio Data\r\n      const audioData = getAudioLevels()\r\n      const volume = audioData.length > 0 \r\n        ? audioData.reduce((a, b) => a + b, 0) / audioData.length / 255 \r\n        : 0\r\n      \r\n      // Clear canvas\r\n      ctx.clearRect(0, 0, rect.width, rect.height)\r\n      const centerX = rect.width / 2\r\n      const centerY = rect.height / 2\r\n      const maxRadius = Math.min(centerX, centerY) - 5\r\n\r\n      // Determine pulsing\r\n      // Pulse entire ring size based on volume\r\n      const pulse = volume * 10\r\n      const currentRadius = baseRadius + (state === 'listening' ? pulse : 0) + (Math.sin(time * 2) * 2)\r\n\r\n      // Draw Main Ring (Background)\r\n      ctx.beginPath()\r\n      ctx.arc(centerX, centerY, currentRadius, 0, Math.PI * 2)\r\n      // Gradient stroke\r\n      const gradient = ctx.createLinearGradient(centerX - currentRadius, centerY - currentRadius, centerX + currentRadius, centerY + currentRadius)\r\n      gradient.addColorStop(0, `rgba(${colors.ring.r}, ${colors.ring.g}, ${colors.ring.b}, 0.8)`)\r\n      gradient.addColorStop(1, `rgba(${colors.active.r}, ${colors.active.g}, ${colors.active.b}, 0.8)`)\r\n      ctx.strokeStyle = gradient\r\n      ctx.lineWidth = 3\r\n      ctx.shadowBlur = 10\r\n      ctx.shadowColor = `rgba(${colors.glow.r}, ${colors.glow.g}, ${colors.glow.b}, 0.5)`\r\n      ctx.stroke()\r\n      ctx.shadowBlur = 0 // Reset shadow\r\n\r\n      // Draw Segments (Ticks)\r\n      const segmentLength = 4\r\n      const gap = 0.1 // radians\r\n      const totalArc = Math.PI * 2\r\n      const segmentAngle = totalArc / segmentCount\r\n\r\n      for (let i = 0; i < segmentCount; i++) {\r\n        const angle = i * segmentAngle + (time * 0.2) // Rotate slowly\r\n        \r\n        // Map audio frequency to specific segments\r\n        // We mirror the audio data around the circle\r\n        const dataIndex = Math.floor(Math.abs((i - segmentCount/2)) / (segmentCount/2) * (audioData.length / 2))\r\n        const value = audioData[dataIndex] || 0\r\n        const intensity = value / 255\r\n\r\n        // Determine segment color and size\r\n        const isActive = intensity > 0.2\r\n        const r = isActive ? colors.active.r : colors.ring.r\r\n        const g = isActive ? colors.active.g : colors.ring.g\r\n        const b = isActive ? colors.active.b : colors.ring.b\r\n        const alpha = 0.4 + (intensity * 0.6)\r\n\r\n        // Calculate segment position\r\n        // Inner or outer ticks based on design? Let's do outer ticks\r\n        const innerR = currentRadius + 2\r\n        const outerR = currentRadius + 2 + segmentLength + (intensity * 10) // Grow outwards\r\n\r\n        const x1 = centerX + Math.cos(angle) * innerR\r\n        const y1 = centerY + Math.sin(angle) * innerR\r\n        const x2 = centerX + Math.cos(angle) * outerR\r\n        const y2 = centerY + Math.sin(angle) * outerR\r\n\r\n        ctx.beginPath()\r\n        ctx.moveTo(x1, y1)\r\n        ctx.lineTo(x2, y2)\r\n        ctx.strokeStyle = `rgba(${r}, ${g}, ${b}, ${alpha})`\r\n        ctx.lineWidth = 2\r\n        ctx.stroke()\r\n      }\r\n\r\n      // Inner Glow / State Indicator\r\n      ctx.globalCompositeOperation = 'lighter'\r\n      const innerGlowParams = {\r\n        radius: currentRadius * 0.8,\r\n        color: `rgba(${colors.ring.r}, ${colors.ring.g}, ${colors.ring.b}, ${0.1 + volume * 0.2})`\r\n      }\r\n      \r\n      if (state === 'processing') {\r\n         innerGlowParams.color = `rgba(255, 255, 255, 0.3)`\r\n      } else if (state === 'error') {\r\n         innerGlowParams.color = `rgba(255, 50, 50, 0.3)`\r\n      }\r\n\r\n      const radGrad = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, innerGlowParams.radius)\r\n      radGrad.addColorStop(0, innerGlowParams.color)\r\n      radGrad.addColorStop(1, 'rgba(0,0,0,0)')\r\n      \r\n      ctx.fillStyle = radGrad\r\n      ctx.beginPath()\r\n      ctx.arc(centerX, centerY, innerGlowParams.radius, 0, Math.PI * 2)\r\n      ctx.fill()\r\n      ctx.globalCompositeOperation = 'source-over'\r\n      \r\n      time += 0.02\r\n      requestRef.current = requestAnimationFrame(animate)\r\n    }\r\n\r\n    requestRef.current = requestAnimationFrame(animate)\r\n\r\n    return () => {\r\n      if (requestRef.current) cancelAnimationFrame(requestRef.current)\r\n    }\r\n  }, [state, size, getAudioLevels])\r\n\r\n  const dimensions = size === 'sm' ? 64 : size === 'lg' ? 96 : 80\r\n\r\n  return (\r\n    <div \r\n      ref={containerRef}\r\n      className={`relative cursor-pointer transition-transform duration-200 hover:scale-105 active:scale-95`}\r\n      onClick={onClick}\r\n      style={{ width: dimensions, height: dimensions, pointerEvents: state === 'connecting' ? 'none' : 'auto', opacity: state === 'connecting' ? 0.7 : 1 }}\r\n    >\r\n      <canvas \r\n        ref={canvasRef}\r\n        className=\"block w-full h-full\"\r\n        style={{ width: dimensions, height: dimensions }}\r\n      />\r\n    </div>\r\n  )\r\n}\r\n\r\n// ============================================================================\r\n// Audio Visualizer Component\r\n// ============================================================================\r\n\r\ninterface AudioVisualizerProps {\r\n  isActive: boolean\r\n  className?: string\r\n}\r\n\r\nfunction AudioVisualizer({ isActive, className }: AudioVisualizerProps) {\r\n  const bars = 5\r\n  \r\n  return (\r\n    <div className={`flex items-center gap-0.5 h-6 ${className ?? ''}`}>\r\n      {Array.from({ length: bars }).map((_, i) => (\r\n        <div\r\n          key={i}\r\n          className={`w-1 bg-current rounded-full transition-all duration-150 ${\r\n            isActive ? 'animate-pulse' : ''\r\n          }`}\r\n          style={{\r\n            height: isActive ? `${Math.random() * 100}%` : '20%',\r\n            animationDelay: `${i * 50}ms`,\r\n          }}\r\n        />\r\n      ))}\r\n    </div>\r\n  )\r\n}\r\n\r\n// ============================================================================\r\n// Status Text Helper\r\n// ============================================================================\r\n\r\nfunction getStatusText(state: VividAgentState): string {\r\n  switch (state) {\r\n    case 'idle':\r\n      return 'Click to start'\r\n    case 'connecting':\r\n      return 'Connecting...'\r\n    case 'ready':\r\n      return 'Listening...'\r\n    case 'listening':\r\n      return 'Hearing you...'\r\n    case 'processing':\r\n      return 'Thinking...'\r\n    case 'speaking':\r\n      return 'Speaking...'\r\n    case 'error':\r\n      return 'Error occurred'\r\n    default:\r\n      return ''\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Main Widget Component\r\n// ============================================================================\r\n\r\nexport function VividWidget({\r\n  position,\r\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n  showTranscript = false, // Default to false as requested\r\n  classNames: customClassNames,\r\n  size = 'md',\r\n}: VividWidgetProps) {\r\n  const {\r\n    state,\r\n    isConnected,\r\n    startSession,\r\n    endSession,\r\n    config,\r\n  } = useVivid()\r\n\r\n  const [isExpanded, setIsExpanded] = useState(false)\r\n  const buttonRef = useRef<HTMLButtonElement>(null)\r\n\r\n  // Merge class names\r\n  const cn = {\r\n    ...defaultClassNames,\r\n    ...config.classNames,\r\n    ...customClassNames,\r\n  }\r\n\r\n  // Handle button click  guard against multiple taps during connection\r\n  const handleClick = useCallback(async () => {\r\n    if (state === 'connecting') return // Ignore taps while connecting\r\n    if (isConnected) {\r\n      endSession()\r\n      setIsExpanded(false)\r\n    } else {\r\n      setIsExpanded(true)\r\n      await startSession()\r\n    }\r\n  }, [state, isConnected, startSession, endSession])\r\n\r\n  // Position styles\r\n  const positionStyle: React.CSSProperties = position\r\n    ? {\r\n        position: 'fixed',\r\n        bottom: position.bottom,\r\n        right: position.right,\r\n        left: position.left,\r\n        top: position.top,\r\n      }\r\n    : {}\r\n\r\n  return (\r\n    <div className={cn.container} style={positionStyle}>\r\n      {/* Main Orb Interface - No transcript, no status text */}\r\n      <OrbVisualizer \r\n        state={state} \r\n        onClick={handleClick}\r\n        size={size}\r\n      />\r\n    </div>\r\n  )\r\n}\r\n\r\n// ============================================================================\r\n// Minimal Widget (just button, no UI)\r\n// ============================================================================\r\n\r\nexport interface VividButtonProps {\r\n  className?: string\r\n  activeClassName?: string\r\n  children?: React.ReactNode\r\n  renderIcon?: (state: VividAgentState) => React.ReactNode\r\n}\r\n\r\n/**\r\n * Minimal button component for custom UI implementations\r\n */\r\nexport function VividButton({\r\n  className,\r\n  activeClassName,\r\n  children,\r\n  renderIcon,\r\n}: VividButtonProps) {\r\n  const { state, isConnected, startSession, endSession } = useVivid()\r\n\r\n  const handleClick = useCallback(async () => {\r\n    if (isConnected) {\r\n      endSession()\r\n    } else {\r\n      await startSession()\r\n    }\r\n  }, [isConnected, startSession, endSession])\r\n\r\n  const isActive = state === 'listening' || state === 'speaking'\r\n\r\n  return (\r\n    <button\r\n      onClick={handleClick}\r\n      disabled={state === 'connecting'}\r\n      className={`${className ?? ''} ${isActive ? activeClassName ?? '' : ''}`}\r\n      aria-label={isConnected ? 'Stop Vivid' : 'Start Vivid'}\r\n    >\r\n      {renderIcon ? renderIcon(state) : children}\r\n    </button>\r\n  )\r\n}\r\n\r\n// ============================================================================\r\n// Transcript Component (standalone)\r\n// ============================================================================\r\n\r\nexport interface VividTranscriptProps {\r\n  className?: string\r\n  maxTurns?: number\r\n}\r\n\r\n/**\r\n * Standalone transcript display component\r\n */\r\nexport function VividTranscript({ className, maxTurns = 10 }: VividTranscriptProps) {\r\n  const { conversation, state } = useVivid()\r\n  const containerRef = useRef<HTMLDivElement>(null)\r\n\r\n  // Auto-scroll to bottom on new messages\r\n  useEffect(() => {\r\n    if (containerRef.current) {\r\n      containerRef.current.scrollTop = containerRef.current.scrollHeight\r\n    }\r\n  }, [conversation])\r\n\r\n  const recentTurns = conversation.slice(-maxTurns)\r\n\r\n  return (\r\n    <div ref={containerRef} className={className}>\r\n      {recentTurns.map((turn) => (\r\n        <div\r\n          key={turn.id}\r\n          className={`mb-2 ${turn.role === 'user' ? 'text-right' : 'text-left'}`}\r\n        >\r\n          <span\r\n            className={`inline-block px-3 py-2 rounded-lg ${\r\n              turn.role === 'user'\r\n                ? 'bg-violet-500 text-white'\r\n                : 'bg-gray-100 dark:bg-gray-800'\r\n            }`}\r\n          >\r\n            {turn.content}\r\n          </span>\r\n        </div>\r\n      ))}\r\n      {state === 'processing' && (\r\n        <div className=\"text-left\">\r\n          <span className=\"inline-block px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800\">\r\n            <span className=\"animate-pulse\">Thinking...</span>\r\n          </span>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","/**\r\n * Audio Handling Utilities\r\n * \r\n * Manages microphone input capture and audio playback for voice conversations\r\n */\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport interface AudioCaptureConfig {\r\n  sampleRate?: number\r\n  channelCount?: number\r\n  onAudioData: (base64Audio: string) => void\r\n  onError: (error: Error) => void\r\n}\r\n\r\nexport interface AudioPlaybackConfig {\r\n  sampleRate?: number\r\n  onPlaybackStart?: () => void\r\n  onPlaybackEnd?: () => void\r\n}\r\n\r\n// ============================================================================\r\n// Audio Capture (Microphone)\r\n// ============================================================================\r\n\r\n/**\r\n * Captures audio from the microphone and converts to PCM16 base64\r\n */\r\nexport class AudioCapture {\r\n  private stream: MediaStream | null = null\r\n  private audioContext: AudioContext | null = null\r\n  private processor: ScriptProcessorNode | null = null\r\n  private source: MediaStreamAudioSourceNode | null = null\r\n  private config: AudioCaptureConfig\r\n  private isCapturing = false\r\n\r\n  constructor(config: AudioCaptureConfig) {\r\n    this.config = {\r\n      sampleRate: 24000, // OpenAI Realtime expects 24kHz\r\n      channelCount: 1,\r\n      ...config,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start capturing audio from the microphone\r\n   */\r\n  async start(): Promise<void> {\r\n    if (this.isCapturing) {\r\n      console.warn('[Vivid Audio] Already capturing')\r\n      return\r\n    }\r\n\r\n    try {\r\n      // Request microphone access\r\n      this.stream = await navigator.mediaDevices.getUserMedia({\r\n        audio: {\r\n          sampleRate: this.config.sampleRate,\r\n          channelCount: this.config.channelCount,\r\n          echoCancellation: true,\r\n          noiseSuppression: true,\r\n          autoGainControl: true,\r\n        },\r\n      })\r\n\r\n      // Create audio context\r\n      this.audioContext = new AudioContext({\r\n        sampleRate: this.config.sampleRate,\r\n      })\r\n\r\n      // Create source from microphone stream\r\n      this.source = this.audioContext.createMediaStreamSource(this.stream)\r\n\r\n      // Create processor node for raw audio data\r\n      // Note: ScriptProcessorNode is deprecated but AudioWorklet requires more setup\r\n      // TODO: Migrate to AudioWorklet for better performance\r\n      this.processor = this.audioContext.createScriptProcessor(4096, 1, 1)\r\n\r\n      this.processor.onaudioprocess = (event) => {\r\n        if (!this.isCapturing) return\r\n\r\n        const inputData = event.inputBuffer.getChannelData(0)\r\n        const pcm16 = this.floatTo16BitPCM(inputData)\r\n        const base64 = this.arrayBufferToBase64(pcm16.buffer as ArrayBuffer)\r\n        this.config.onAudioData(base64)\r\n      }\r\n\r\n      // Connect the audio graph\r\n      this.source.connect(this.processor)\r\n      this.processor.connect(this.audioContext.destination)\r\n\r\n      this.isCapturing = true\r\n      console.log('[Vivid Audio] Capture started')\r\n    } catch (error) {\r\n      this.config.onError(\r\n        error instanceof Error ? error : new Error('Failed to start audio capture')\r\n      )\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop capturing audio\r\n   */\r\n  stop(): void {\r\n    this.isCapturing = false\r\n\r\n    if (this.processor) {\r\n      this.processor.disconnect()\r\n      this.processor = null\r\n    }\r\n\r\n    if (this.source) {\r\n      this.source.disconnect()\r\n      this.source = null\r\n    }\r\n\r\n    if (this.audioContext) {\r\n      this.audioContext.close()\r\n      this.audioContext = null\r\n    }\r\n\r\n    if (this.stream) {\r\n      this.stream.getTracks().forEach((track) => track.stop())\r\n      this.stream = null\r\n    }\r\n\r\n    console.log('[Vivid Audio] Capture stopped')\r\n  }\r\n\r\n  /**\r\n   * Check if currently capturing\r\n   */\r\n  isActive(): boolean {\r\n    return this.isCapturing\r\n  }\r\n\r\n  /**\r\n   * Convert float32 audio data to 16-bit PCM\r\n   */\r\n  private floatTo16BitPCM(float32Array: Float32Array): Int16Array {\r\n    const int16Array = new Int16Array(float32Array.length)\r\n    for (let i = 0; i < float32Array.length; i++) {\r\n      const s = Math.max(-1, Math.min(1, float32Array[i]))\r\n      int16Array[i] = s < 0 ? s * 0x8000 : s * 0x7fff\r\n    }\r\n    return int16Array\r\n  }\r\n\r\n  /**\r\n   * Convert ArrayBuffer to base64 string\r\n   */\r\n  private arrayBufferToBase64(buffer: ArrayBuffer): string {\r\n    const bytes = new Uint8Array(buffer)\r\n    let binary = ''\r\n    for (let i = 0; i < bytes.byteLength; i++) {\r\n      binary += String.fromCharCode(bytes[i])\r\n    }\r\n    return btoa(binary)\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Audio Playback (Speaker)\r\n// ============================================================================\r\n\r\n/**\r\n * Plays PCM16 audio data received from the API\r\n */\r\nexport class AudioPlayback {\r\n  private audioContext: AudioContext | null = null\r\n  private config: AudioPlaybackConfig\r\n  private isPlaying = false\r\n  private audioQueue: AudioBuffer[] = []\r\n  private currentSource: AudioBufferSourceNode | null = null\r\n  private nextStartTime = 0\r\n\r\n  constructor(config: AudioPlaybackConfig = {}) {\r\n    this.config = {\r\n      sampleRate: 24000, // OpenAI Realtime outputs 24kHz\r\n      ...config,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize the audio context (must be called after user interaction)\r\n   */\r\n  async init(): Promise<void> {\r\n    if (this.audioContext) return\r\n\r\n    this.audioContext = new AudioContext({\r\n      sampleRate: this.config.sampleRate,\r\n    })\r\n\r\n    // Resume context if suspended (autoplay policy)\r\n    if (this.audioContext.state === 'suspended') {\r\n      await this.audioContext.resume()\r\n    }\r\n    console.log('[Vivid Audio] Playback initialized, state:', this.audioContext.state, 'sampleRate:', this.audioContext.sampleRate)\r\n  }\r\n\r\n  /**\r\n   * Add audio data to the playback queue\r\n   */\r\n  async enqueue(pcm16Buffer: ArrayBuffer): Promise<void> {\r\n    if (!this.audioContext) {\r\n      await this.init()\r\n    }\r\n\r\n    // Resume if suspended (browser autoplay policy)\r\n    if (this.audioContext!.state === 'suspended') {\r\n      console.log('[Vivid Audio] Resuming suspended audio context')\r\n      await this.audioContext!.resume()\r\n    }\r\n\r\n    try {\r\n      console.log('[Vivid Audio] Enqueue PCM16 buffer, byteLength:', pcm16Buffer.byteLength)\r\n      // Convert PCM16 to float32\r\n      const float32 = this.pcm16ToFloat32(pcm16Buffer)\r\n\r\n      // Create audio buffer\r\n      const audioBuffer = this.audioContext!.createBuffer(\r\n        1, // mono\r\n        float32.length,\r\n        this.config.sampleRate!\r\n      )\r\n      audioBuffer.copyToChannel(new Float32Array(float32), 0)\r\n\r\n      // Add to queue and play\r\n      this.audioQueue.push(audioBuffer)\r\n      this.playNext()\r\n    } catch (error) {\r\n      console.error('[Vivid Audio] Error enqueueing audio:', error)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Play the next audio chunk in the queue\r\n   */\r\n  private playNext(): void {\r\n    if (!this.audioContext || this.audioQueue.length === 0) return\r\n\r\n    // Start playback notification\r\n    if (!this.isPlaying) {\r\n      this.isPlaying = true\r\n      this.nextStartTime = this.audioContext.currentTime\r\n      this.config.onPlaybackStart?.()\r\n    }\r\n\r\n    while (this.audioQueue.length > 0) {\r\n      const buffer = this.audioQueue.shift()!\r\n      const source = this.audioContext.createBufferSource()\r\n      source.buffer = buffer\r\n      source.connect(this.audioContext.destination)\r\n\r\n      // Schedule this chunk\r\n      const startTime = Math.max(this.nextStartTime, this.audioContext.currentTime)\r\n      source.start(startTime)\r\n      this.nextStartTime = startTime + buffer.duration\r\n\r\n      // Track when playback ends\r\n      source.onended = () => {\r\n        if (this.audioQueue.length === 0 && this.audioContext) {\r\n          // Small delay to check if more audio is coming\r\n          setTimeout(() => {\r\n            if (this.audioQueue.length === 0) {\r\n              this.isPlaying = false\r\n              this.config.onPlaybackEnd?.()\r\n            }\r\n          }, 100)\r\n        }\r\n      }\r\n\r\n      this.currentSource = source\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop all playback and clear the queue\r\n   */\r\n  stop(): void {\r\n    this.audioQueue = []\r\n    \r\n    if (this.currentSource) {\r\n      try {\r\n        this.currentSource.stop()\r\n      } catch {\r\n        // Ignore if already stopped\r\n      }\r\n      this.currentSource = null\r\n    }\r\n\r\n    this.isPlaying = false\r\n    this.nextStartTime = 0\r\n  }\r\n\r\n  /**\r\n   * Clean up resources\r\n   */\r\n  dispose(): void {\r\n    this.stop()\r\n    \r\n    if (this.audioContext) {\r\n      this.audioContext.close()\r\n      this.audioContext = null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if currently playing\r\n   */\r\n  isActive(): boolean {\r\n    return this.isPlaying\r\n  }\r\n\r\n  /**\r\n   * Convert PCM16 buffer to float32 array\r\n   */\r\n  private pcm16ToFloat32(buffer: ArrayBuffer): Float32Array {\r\n    const int16 = new Int16Array(buffer)\r\n    const float32 = new Float32Array(int16.length)\r\n    for (let i = 0; i < int16.length; i++) {\r\n      float32[i] = int16[i] / (int16[i] < 0 ? 0x8000 : 0x7fff)\r\n    }\r\n    return float32\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Audio Level Analyzer (for visualization)\r\n// ============================================================================\r\n\r\n/**\r\n * Analyzes audio levels for visualization\r\n */\r\nexport class AudioLevelAnalyzer {\r\n  private analyser: AnalyserNode | null = null\r\n  private dataArray: Uint8Array | null = null\r\n\r\n  /**\r\n   * Connect to an audio context and source\r\n   */\r\n  connect(audioContext: AudioContext, source: AudioNode): void {\r\n    this.analyser = audioContext.createAnalyser()\r\n    this.analyser.fftSize = 256\r\n    this.dataArray = new Uint8Array(this.analyser.frequencyBinCount)\r\n    source.connect(this.analyser)\r\n  }\r\n\r\n  /**\r\n   * Get the current audio level (0-1)\r\n   */\r\n  getLevel(): number {\r\n    if (!this.analyser || !this.dataArray) return 0\r\n\r\n    this.analyser.getByteFrequencyData(new Uint8Array(this.dataArray))\r\n    \r\n    // Calculate average level\r\n    let sum = 0\r\n    for (let i = 0; i < this.dataArray.length; i++) {\r\n      sum += this.dataArray[i]\r\n    }\r\n    return sum / (this.dataArray.length * 255)\r\n  }\r\n\r\n  /**\r\n   * Disconnect and clean up\r\n   */\r\n  disconnect(): void {\r\n    if (this.analyser) {\r\n      this.analyser.disconnect()\r\n      this.analyser = null\r\n    }\r\n    this.dataArray = null\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Utility Functions\r\n// ============================================================================\r\n\r\n/**\r\n * Check if the browser supports audio capture\r\n */\r\nexport function isAudioCaptureSupported(): boolean {\r\n  return !!(\r\n    typeof navigator !== 'undefined' &&\r\n    navigator.mediaDevices &&\r\n    typeof navigator.mediaDevices.getUserMedia === 'function' &&\r\n    typeof window !== 'undefined' &&\r\n    typeof window.AudioContext !== 'undefined'\r\n  )\r\n}\r\n\r\n/**\r\n * Request microphone permission\r\n */\r\nexport async function requestMicrophonePermission(): Promise<PermissionState> {\r\n  try {\r\n    // Try to query permission status\r\n    if (navigator.permissions) {\r\n      const result = await navigator.permissions.query({ name: 'microphone' as PermissionName })\r\n      return result.state\r\n    }\r\n    // Fallback: try to get user media\r\n    const stream = await navigator.mediaDevices.getUserMedia({ audio: true })\r\n    stream.getTracks().forEach((track) => track.stop())\r\n    return 'granted'\r\n  } catch {\r\n    return 'denied'\r\n  }\r\n}\r\n"]}