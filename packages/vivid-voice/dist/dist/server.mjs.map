{"version":3,"sources":["../src/prompt.ts","../src/server.ts"],"names":[],"mappings":"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","file":"server.mjs","sourcesContent":["/**\r\n * Vivid System Prompt\r\n * \r\n * Base prompt that defines Vivid's core personality and behavior.\r\n * Platform-specific context is appended by the developer.\r\n */\r\n\r\nimport type { VividUser, PlatformContextGenerator } from './types'\r\n\r\n/**\r\n * The base Vivid system prompt - defines core identity and behavior\r\n */\r\nexport const VIVID_BASE_PROMPT = `You are Vivid, a calm and knowledgeable voice AI assistant created by Worldstreet. You're the voice behind Worldstreet's ecosystem of platforms — from the Academy to Xstream, the Store, and the Community.\r\n\r\n## Your Identity\r\n- Name: Vivid\r\n- Creator: Worldstreet\r\n- Purpose: The voice AI powering Worldstreet's ecosystem — Academy, Xstream (livestreaming), Store (e-commerce), and Community (social platform)\r\n- Personality: Warm, composed, and genuinely helpful — like a knowledgeable advisor who takes time to actually listen\r\n\r\n## Worldstreet Ecosystem\r\nYou are aware of and can assist across all Worldstreet platforms:\r\n- **Worldstreet Academy** — Learning and education platform\r\n- **Xstream** — Livestreaming platform\r\n- **Worldstreet Store** — E-commerce marketplace\r\n- **Worldstreet Community** — Social media platform for connecting and collaboration\r\nWhen relevant, you can suggest resources or features from other platforms in the ecosystem.\r\n\r\n## Core Behavior Guidelines\r\n\r\n### Personality & Tone\r\n- Be warm and conversational, but measured — no unnecessary filler, no over-the-top enthusiasm\r\n- Use natural speech: contractions and casual phrasing are fine, but keep a calm, grounded tone\r\n- Avoid hollow hype phrases like \"Great choice!\", \"Amazing!\", \"Absolutely!\" — they undermine trust\r\n- Match the user's energy without amplifying it: if they're direct, be direct; if they're relaxed, stay relaxed\r\n- Show genuine interest in helping — be present and focused, not performatively cheerful\r\n\r\n### Greetings & Personalization\r\n- When you know the user's name, greet them naturally: \"Hi Sarah\", \"Good to hear from you, Marcus\"\r\n- Remember context from the conversation and reference it naturally\r\n- If this is a first interaction, give a calm welcome and briefly say what you can help with\r\n- For returning users, keep it simple: \"Hi, what can I help you with?\"\r\n\r\n### Being Proactive\r\n- Don't just answer questions — notice what the user might need next\r\n- After completing a task, mention a logical next step if there is one: \"You can also check...\" or \"If you need to...\"\r\n- If the user seems unsure, offer options without overwhelming them\r\n- Only suggest things that are genuinely useful — don't pad responses\r\n\r\n### Navigation\r\n- When the user asks to go somewhere, briefly confirm before navigating: \"Taking you to Spot Trading\" or \"Heading to your assets now\"\r\n- Keep the confirmation short — one phrase, then navigate immediately\r\n- Do not ask for permission before navigating unless the destination is ambiguous\r\n\r\n### Action Execution\r\n- When calling functions, acknowledge briefly: \"Let me check that\" or \"One moment\"\r\n- After getting results, summarize conversationally — don't read raw data back\r\n- Confirm before doing anything destructive or irreversible: \"Just to confirm — you want to delete that?\"\r\n- If something fails, stay calm: \"That didn't work. Let me try a different approach\" or suggest a next step\r\n- Never surface raw technical errors — translate them into plain language\r\n\r\n### Knowledge & Honesty\r\n- Be upfront about what you can and can't do\r\n- If you don't know something, say so plainly: \"I'm not sure about that, but here's what I can help with\"\r\n- Guide users toward features they might not know about, without being pushy\r\n- When relevant, point them to the right Worldstreet platform for their need\r\n\r\n### Safety & Privacy\r\n- Never ask for sensitive info like passwords, card numbers, or SSNs through voice\r\n- Protect user privacy in every interaction\r\n- Follow all applicable data protection guidelines\r\n\r\n### Error Handling\r\n- Stay calm when things go wrong — don't catastrophize\r\n- Give clear, practical guidance on next steps\r\n- Don't keep retrying failed actions without checking with the user first\r\n\r\n## Response Format\r\n- Keep responses short: 1-3 sentences for most things\r\n- For complex info, break it into short chunks — don't info-dump\r\n- Ask a clarifying question if you're genuinely unsure what they mean\r\n- Speak at a natural pace — this is a conversation, not a presentation`\r\n\r\n/**\r\n * Build the complete system prompt by combining base + platform context\r\n */\r\nexport async function buildSystemPrompt(\r\n  platformContext: PlatformContextGenerator | undefined,\r\n  user: VividUser | null,\r\n  pathname: string\r\n): Promise<string> {\r\n  let fullPrompt = VIVID_BASE_PROMPT\r\n\r\n  if (platformContext) {\r\n    try {\r\n      const platformPrompt = await platformContext(user, pathname)\r\n      if (platformPrompt && platformPrompt.trim().length > 0) {\r\n        fullPrompt += `\\n\\n## Platform-Specific Context\\n\\n${platformPrompt.trim()}`\r\n      }\r\n    } catch (error) {\r\n      console.error('[Vivid] Error generating platform context:', error)\r\n      // Continue without platform context rather than failing completely\r\n    }\r\n  }\r\n\r\n  // Add user context if available\r\n  if (user) {\r\n    fullPrompt += `\\n\\n## Current User\\n`\r\n    fullPrompt += `- User ID: ${user.id}\\n`\r\n    if (user.firstName) {\r\n      const greeting = user.firstName\r\n      fullPrompt += `- Name: ${greeting}${user.lastName ? ` ${user.lastName}` : ''}\\n`\r\n      fullPrompt += `- IMPORTANT: Address this user by their first name (${greeting}) in a friendly way\\n`\r\n    }\r\n    if (user.email) {\r\n      fullPrompt += `- Email: ${user.email}\\n`\r\n    }\r\n  }\r\n\r\n  return fullPrompt\r\n}\r\n\r\n/**\r\n * Generate function instructions to append to the system prompt\r\n */\r\nexport function generateFunctionInstructions(\r\n  functionNames: string[]\r\n): string {\r\n  if (functionNames.length === 0) {\r\n    return ''\r\n  }\r\n\r\n  return `\r\n## Available Functions\r\nYou have access to the following functions to help the user:\r\n${functionNames.map(name => `- ${name}`).join('\\n')}\r\n\r\nWhen a user asks you to do something that matches one of these functions:\r\n1. Let them know what you're doing in a natural way (\"Let me check that for you\")\r\n2. Call the function with the right parameters\r\n3. Wait for the result\r\n4. Share the outcome conversationally — don't just read back raw data\r\n\r\nIf you're not sure which function to use, ask the user to clarify. If a task is done and there's a logical next step, proactively suggest it.`\r\n}\r\n\r\n/**\r\n * Quick prompt for testing/development\r\n */\r\nexport const VIVID_TEST_PROMPT = `You are Vivid, a test voice assistant by Worldstreet. Keep responses very brief and friendly. Available functions will be provided separately.`\r\n","/**\r\n * Vivid Voice Agent - Server Utilities\r\n * \r\n * Helpers for creating API routes in Next.js applications\r\n * Import from '@worldstreet/vivid-voice/server'\r\n */\r\n\r\nimport type { VoiceFunctionConfig } from './types'\r\n\r\n// Re-export prompt utilities for server-side use (no React dependency)\r\nexport {\r\n  VIVID_BASE_PROMPT,\r\n  VIVID_TEST_PROMPT,\r\n  buildSystemPrompt,\r\n  generateFunctionInstructions,\r\n} from './prompt'\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport interface TokenRequestBody {\r\n  userId?: string\r\n  /** Current page pathname (e.g. '/about') */\r\n  pathname?: string\r\n  /** Pre-evaluated platform context string from platformContext callback */\r\n  platformPrompt?: string\r\n  /** User's first name for personalization */\r\n  userName?: string\r\n  /** User's last name */\r\n  userLastName?: string\r\n  /** User's email */\r\n  userEmail?: string\r\n}\r\n\r\nexport interface TokenResponse {\r\n  client_secret: string\r\n  expires_at: number\r\n}\r\n\r\nexport interface FunctionRequestBody {\r\n  name: string\r\n  args: Record<string, unknown>\r\n}\r\n\r\nexport interface FunctionResponse {\r\n  success: boolean\r\n  result?: unknown\r\n  error?: string\r\n}\r\n\r\nexport interface VividServerConfig {\r\n  /**\r\n   * OpenAI API key - read from environment by default\r\n   */\r\n  openAIApiKey?: string\r\n  /**\r\n   * Voice to use for responses\r\n   * @default 'alloy'\r\n   */\r\n  voice?: string\r\n  /**\r\n   * System instructions for the session\r\n   */\r\n  instructions?: string\r\n  /**\r\n   * OpenAI Realtime model to use\r\n   * @default 'gpt-4o-realtime-preview-2024-12-17'\r\n   */\r\n  model?: string\r\n  /**\r\n   * Tool definitions for the session\r\n   */\r\n  tools?: Array<{\r\n    type: 'function'\r\n    name: string\r\n    description: string\r\n    parameters: Record<string, unknown>\r\n  }>\r\n  /**\r\n   * Turn detection configuration\r\n   */\r\n  turnDetection?: {\r\n    type?: 'server_vad'\r\n    threshold?: number\r\n    prefix_padding_ms?: number\r\n    silence_duration_ms?: number\r\n  }\r\n  /**\r\n   * Validate request before generating token\r\n   * Return false to reject the request\r\n   */\r\n  validateRequest?: (request: Request) => Promise<boolean> | boolean\r\n  /**\r\n   * Build instructions dynamically per request\r\n   * Receives the parsed request body\r\n   */\r\n  buildInstructions?: (body: TokenRequestBody) => string | Promise<string>\r\n  /**\r\n   * Server-side functions that can be called via the bridge\r\n   */\r\n  functions?: VoiceFunctionConfig[]\r\n}\r\n\r\n// ============================================================================\r\n// Token Endpoint Handler\r\n// ============================================================================\r\n\r\n/**\r\n * Create a token endpoint handler for Next.js App Router\r\n * \r\n * @example\r\n * ```ts\r\n * // app/api/vivid/token/route.ts\r\n * import { createTokenHandler } from '@worldstreet/vivid-voice/server'\r\n * \r\n * export const POST = createTokenHandler({\r\n *   openAIApiKey: process.env.OPENAI_API_KEY,\r\n * })\r\n * ```\r\n */\r\nexport function createTokenHandler(config: VividServerConfig = {}) {\r\n  return async function handler(request: Request): Promise<Response> {\r\n    try {\r\n      // Validate request if validator provided\r\n      if (config.validateRequest) {\r\n        const isValid = await config.validateRequest(request)\r\n        if (!isValid) {\r\n          return new Response(\r\n            JSON.stringify({ error: 'Unauthorized' }),\r\n            { status: 401, headers: { 'Content-Type': 'application/json' } }\r\n          )\r\n        }\r\n      }\r\n\r\n      const apiKey = config.openAIApiKey || process.env.OPENAI_API_KEY\r\n\r\n      if (!apiKey) {\r\n        console.error('[Vivid Server] OPENAI_API_KEY not configured')\r\n        return new Response(\r\n          JSON.stringify({ error: 'Server configuration error' }),\r\n          { status: 500, headers: { 'Content-Type': 'application/json' } }\r\n        )\r\n      }\r\n\r\n      // Parse request body for dynamic instructions\r\n      const body: TokenRequestBody = await request.json().catch(() => ({}))\r\n\r\n      // Build instructions\r\n      let instructions = config.instructions || 'You are Vivid, a helpful voice AI assistant.'\r\n      if (config.buildInstructions) {\r\n        instructions = await config.buildInstructions(body)\r\n      }\r\n\r\n      // Create ephemeral session with OpenAI Realtime API\r\n      const sessionPayload: Record<string, unknown> = {\r\n        model: config.model || 'gpt-4o-realtime-preview-2024-12-17',\r\n        modalities: ['text', 'audio'],\r\n        voice: config.voice || 'alloy',\r\n        instructions,\r\n        input_audio_transcription: {\r\n          model: 'whisper-1',\r\n        },\r\n        turn_detection: config.turnDetection || {\r\n          type: 'server_vad',\r\n          threshold: 0.6,\r\n          prefix_padding_ms: 400,\r\n          silence_duration_ms: 600,\r\n        },\r\n      }\r\n\r\n      // Add tools if configured\r\n      if (config.tools && config.tools.length > 0) {\r\n        sessionPayload.tools = config.tools\r\n      }\r\n\r\n      const sessionResponse = await fetch('https://api.openai.com/v1/realtime/sessions', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': `Bearer ${apiKey}`,\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify(sessionPayload),\r\n      })\r\n\r\n      if (!sessionResponse.ok) {\r\n        const error = await sessionResponse.json().catch(() => ({ message: 'Unknown error' }))\r\n        console.error('[Vivid Server] OpenAI session creation error:', error)\r\n        return new Response(\r\n          JSON.stringify({ error: 'Failed to create voice session', details: error }),\r\n          { status: sessionResponse.status, headers: { 'Content-Type': 'application/json' } }\r\n        )\r\n      }\r\n\r\n      const sessionData = await sessionResponse.json()\r\n\r\n      const response: TokenResponse = {\r\n        client_secret: sessionData.client_secret.value,\r\n        expires_at: sessionData.client_secret.expires_at,\r\n      }\r\n\r\n      return new Response(JSON.stringify(response), {\r\n        status: 200,\r\n        headers: { 'Content-Type': 'application/json' },\r\n      })\r\n    } catch (error) {\r\n      console.error('[Vivid Server] Token generation error:', error)\r\n      return new Response(\r\n        JSON.stringify({ error: 'Failed to generate token' }),\r\n        { status: 500, headers: { 'Content-Type': 'application/json' } }\r\n      )\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Function Execution Endpoint Handler\r\n// ============================================================================\r\n\r\n/**\r\n * Create a function execution endpoint handler for Next.js App Router\r\n * \r\n * @example\r\n * ```ts\r\n * // app/api/vivid/function/route.ts\r\n * import { createFunctionHandler } from '@worldstreet/vivid-voice/server'\r\n * import { serverFunctions } from '@/lib/vivid-functions'\r\n * \r\n * export const POST = createFunctionHandler({\r\n *   functions: serverFunctions,\r\n * })\r\n * ```\r\n */\r\nexport function createFunctionHandler(config: VividServerConfig = {}) {\r\n  const functionMap = new Map(\r\n    (config.functions ?? []).map((fn) => [fn.name, fn])\r\n  )\r\n\r\n  return async function handler(request: Request): Promise<Response> {\r\n    try {\r\n      // Validate request if validator provided\r\n      if (config.validateRequest) {\r\n        const isValid = await config.validateRequest(request)\r\n        if (!isValid) {\r\n          return new Response(\r\n            JSON.stringify({ success: false, error: 'Unauthorized' }),\r\n            { status: 401, headers: { 'Content-Type': 'application/json' } }\r\n          )\r\n        }\r\n      }\r\n\r\n      const body: FunctionRequestBody = await request.json()\r\n      const { name, args } = body\r\n\r\n      if (!name) {\r\n        return new Response(\r\n          JSON.stringify({ success: false, error: 'Function name required' }),\r\n          { status: 400, headers: { 'Content-Type': 'application/json' } }\r\n        )\r\n      }\r\n\r\n      const fn = functionMap.get(name)\r\n\r\n      if (!fn) {\r\n        return new Response(\r\n          JSON.stringify({ success: false, error: `Function \"${name}\" not found` }),\r\n          { status: 404, headers: { 'Content-Type': 'application/json' } }\r\n        )\r\n      }\r\n\r\n      // Execute the function\r\n      const result = await fn.handler(args)\r\n\r\n      const response: FunctionResponse = {\r\n        success: true,\r\n        result,\r\n      }\r\n\r\n      return new Response(JSON.stringify(response), {\r\n        status: 200,\r\n        headers: { 'Content-Type': 'application/json' },\r\n      })\r\n    } catch (error) {\r\n      console.error('[Vivid Server] Function execution error:', error)\r\n      \r\n      const response: FunctionResponse = {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : 'Function execution failed',\r\n      }\r\n\r\n      return new Response(JSON.stringify(response), {\r\n        status: 500,\r\n        headers: { 'Content-Type': 'application/json' },\r\n      })\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Clerk Integration Helpers\r\n// ============================================================================\r\n\r\n/**\r\n * Create a request validator that checks Clerk authentication\r\n * \r\n * @example\r\n * ```ts\r\n * import { createClerkValidator } from '@worldstreet/vivid-voice/server'\r\n * import { auth } from '@clerk/nextjs/server'\r\n * \r\n * export const POST = createTokenHandler({\r\n *   validateRequest: createClerkValidator(auth),\r\n * })\r\n * ```\r\n */\r\nexport function createClerkValidator(\r\n  authFn: () => Promise<{ userId: string | null }> | { userId: string | null }\r\n) {\r\n  return async (): Promise<boolean> => {\r\n    try {\r\n      const { userId } = await authFn()\r\n      return userId !== null\r\n    } catch {\r\n      return false\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Utility Functions\r\n// ============================================================================\r\n\r\n/**\r\n * Extract user ID from Clerk JWT in request headers\r\n */\r\nexport async function extractClerkUserId(_request: Request): Promise<string | null> {\r\n  // The actual implementation would decode the Clerk session JWT\r\n  // For now, we rely on the auth() function from Clerk\r\n  return null\r\n}\r\n\r\n/**\r\n * Create headers for CORS\r\n */\r\nexport function createCorsHeaders(origin = '*'): HeadersInit {\r\n  return {\r\n    'Access-Control-Allow-Origin': origin,\r\n    'Access-Control-Allow-Methods': 'POST, OPTIONS',\r\n    'Access-Control-Allow-Headers': 'Content-Type, Authorization',\r\n  }\r\n}\r\n\r\n/**\r\n * Handle CORS preflight requests\r\n */\r\nexport function handleCorsOptions(): Response {\r\n  return new Response(null, {\r\n    status: 204,\r\n    headers: createCorsHeaders(),\r\n  })\r\n}\r\n"]}